# 02. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¶•
<br/>

## ğŸ–¥ï¸ ë°ì´í„°ë² ì´ìŠ¤ í™˜ê²½ ì„¤ì •
### [1] Docker ê¸°ë°˜ MySQL ë¡œì»¬ ì„œë²„

#### â—¼ï¸ SSHë¥¼ í™œìš©í•œ EC2 ì„œë²„ ì™¸ë¶€ ì ‘ì†
```
# í”„ë¼ì´ë¹— í‚¤ íŒŒì¼(.pem) ì¡´ì¬ ê²½ë¡œë¡œ ì´ë™ í›„, í”„ë¼ì´ë¹— í‚¤ ì¡°íšŒ(READ) ê¶Œí•œ ë¶€ì—¬
$ chmod 400 bh-EC2.pem

# sshë¥¼ í†µí•œ ì„œë²„ ì ‘ì†
ssh -i "[key-pairëª…].pem" ubuntu@[í¼ë¸”ë¦­ DNS]
```

#### â—¼ï¸ EC2 ì„œë²„ì— Docker ì„¤ì¹˜
```
# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
sudo apt update

# Docker í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# Docker GPG í‚¤ ì¶”ê°€
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Docker ì €ì¥ì†Œ ì¶”ê°€
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Docker ì„¤ì¹˜
sudo apt update
sudo apt install -y docker-ce

# Docker ì„¤ì¹˜ í™•ì¸
docker --version

# Docker ì‹¤í–‰
sudo systemctl start docker
```

#### â—¼ï¸ MySQL ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
```
# ubuntu ì‚¬ìš©ìë¥¼ Docker ê·¸ë£¹ì— ì¶”ê°€: /var/run/docker.sock íŒŒì¼(= Docker ë°ëª¬ ì†Œì¼“) ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬
sudo usermod -aG docker $USER

# EC2 ì„œë²„ ì¢…ë£Œ í›„ ì¬ì ‘ì†
exit
ssh -i "[key-pairëª…].pem" ubuntu@[í¼ë¸”ë¦­ DNS]

# MySQL Docker ì´ë¯¸ì§€ ë‹¤ìš´
docker pull mysql:latest

# MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run --name [ì»¨í…Œì´ë„ˆ ì´ë¦„] -e MYSQL_ROOT_PASSWORD=[ë¹„ë°€ë²ˆí˜¸] -p 3306:3306 -d mysql:latest

# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps
```

#### â—¼ï¸ MYSQL ë°ì´í„° ì˜ì†ì„± ì„¤ì • (ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì„¤ì •)
```
# ë³¼ë¥¨ ìƒì„±
docker volume create mysql-data

# ì»¨í…Œì´ë„ˆ ë¶ˆë¥¨ ë§ˆìš´íŠ¸
docker stop mysql-container
docker rm mysql-container
docker run --name mysql-container \
  -e MYSQL_ROOT_PASSWORD=ehpark \
  -v ~/mysql-data:/var/lib/mysql \
  -v ~/mysql-config/my.cnf \
  -p 3306:3306 \
  -d mysql:latest
```

#### â—¼ï¸ MYSQL ì„œë²„ ì ‘ì†
```
# MySQL ì„œë²„ ì ‘ì†
docker exec -it mysql-container mysql -u root -p
```
<br/>

## ğŸ“‘ DDL ìŠ¤í¬ë¦½íŠ¸

### [1] í…Œì´ë¸” ìƒì„±
```sql
-- =============================================
-- File: 01_Create-Tables.sql
-- Description: Create tables for RentCar DB
-- =============================================

-- ê³ ê° (CUSTOMER)
CREATE TABLE CUSTOMER (
    customer_id       INT AUTO_INCREMENT,
    account_id        VARCHAR(50) NOT NULL UNIQUE,
    account_pw        VARCHAR(50) NOT NULL,
    customer_name     VARCHAR(50) NOT NULL,
    birth_date        DATE NOT NULL,
    gender            VARCHAR(10) NOT NULL,
    phone             VARCHAR(20) NOT NULL UNIQUE,
    email             VARCHAR(100) NOT NULL UNIQUE,
    is_deleted        BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (customer_id)
);

-- ë©´í—ˆ (LICENSE)
CREATE TABLE DRIVER (
    license_id      INT AUTO_INCREMENT,
    customer_id     INT NOT NULL,
    license_number  VARCHAR(20) NOT NULL UNIQUE,
    license_type    VARCHAR(10) NOT NULL,
    license_class   VARCHAR(10) NOT NULL,
    issue_date      DATE NOT NULL,
    expiry_date     DATE NOT NULL,
    PRIMARY KEY (license_id)
);

-- ì°¨ëŸ‰ (CAR)
CREATE TABLE CAR (
    car_id          INT AUTO_INCREMENT,
    branch_id       INT NOT NULL,
    car_number      VARCHAR(20) NOT NULL UNIQUE,
    car_model       VARCHAR(50) NOT NULL,
    fuel_type       VARCHAR(10) NOT NULL,
    car_year        INT NOT NULL,
    seat_count      INT NOT NULL,
    car_mileage     INT NOT NULL,
    fuel_remaining  INT NOT NULL,
    car_status      VARCHAR(10) NOT NULL DEFAULT 'AV', -- ëŒ€ì—¬ê°€ëŠ¥
    is_deleted      BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (car_id)
);

-- ì§€ì  (BRANCH)
CREATE TABLE BRANCH (
    branch_id    INT AUTO_INCREMENT,
    branch_name  VARCHAR(50) NOT NULL UNIQUE,
    address      VARCHAR(100) NOT NULL,
    phone        VARCHAR(20) NOT NULL UNIQUE,
    open_time    TIME NOT NULL,
    close_time   TIME NOT NULL,
    is_deleted   BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (branch_id)
);

-- ëŒ€ì—¬ (RENTAL)
CREATE TABLE RENTAL (
    rental_id        INT AUTO_INCREMENT,
    customer_id      INT NOT NULL,
    car_id           INT NOT NULL,
    start_datetime   DATETIME NOT NULL,
    end_datetime     DATETIME NOT NULL,
    return_datetime  DATETIME NULL,
    insurance_type   VARCHAR(20) NOT NULL,
    start_fuel       INT NOT NULL,
    return_fuel      INT NULL,
    rental_status    VARCHAR(20) NOT NULL DEFAULT 'RS', -- ì˜ˆì•½ì™„ë£Œ
    PRIMARY KEY (rental_id)
);

-- ê²°ì œ (PAYMENT)
CREATE TABLE PAYMENT (
    payment_id         INT AUTO_INCREMENT,
    rental_id          INT NULL,
    accident_id        INT NULL,
    payment_datetime   DATETIME NOT NULL DEFAULT NOW(),
    payment_type       VARCHAR(20) NOT NULL,
    payment_method     VARCHAR(50) NOT NULL,
    payment_method_id  VARCHAR(50) NOT NULL,
    payment_status     VARCHAR(20) NOT NULL,
    total_amount       DECIMAL(20,2) NOT NULL,
    rental_amount      DECIMAL(20,2) NULL,
    insurance_fee      DECIMAL(20,2) NULL,
    discount_amount    DECIMAL(20,2) NULL,
    mileage_used       DECIMAL(20,2) NULL,
    mileage_earned     DECIMAL(20,2) NULL,
    PRIMARY KEY (payment_id)
);

-- í• ì¸ì •ì±… (DISCOUNT_POLICY)
CREATE TABLE DISCOUNT_POLICY (
    discount_policy_id  INT AUTO_INCREMENT,
    discount_type       VARCHAR(20) NOT NULL,
    discount_amount     DECIMAL(20,2) NULL,
    discount_rate       INT NULL,
    start_date          DATE NOT NULL,
    end_date            DATE NOT NULL,
    is_deleted          BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (discount_policy_id)
);

-- ë§ˆì¼ë¦¬ì§€ì •ì±… (MILEAGE_POLICY)
CREATE TABLE MILEAGE_POLICY (
    mileage_policy_id  INT AUTO_INCREMENT,
    earning_type       VARCHAR(20) NOT NULL,
    earning_amount     DECIMAL(20,2) NULL,
    earning_rate       INT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (mileage_policy_id)
);

-- ì‚¬ê³ ì´ë ¥ (ACCIDENT)
CREATE TABLE ACCIDENT (
    accident_id        INT AUTO_INCREMENT,
    car_id             INT NOT NULL,
    rental_id          INT NULL,
    customer_id        INT NULL,
    accident_datetime  DATETIME NOT NULL,
    accident_type      VARCHAR(20) NOT NULL,
    accident_location  VARCHAR(50) NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (accident_id)
);

-- ì •ë¹„ì´ë ¥ (MAINTENANCE)
CREATE TABLE MAINTENANCE (
    maintenance_id      INT AUTO_INCREMENT,
    car_id              INT NOT NULL,
    start_date          DATE NOT NULL,
    end_date            DATE NOT NULL,
    maintenance_type    VARCHAR(20) NOT NULL,
    maintenance_fee     DECIMAL(20,2) NOT NULL,
    maintenance_vendor  VARCHAR(50) NOT NULL,
    is_deleted          BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (maintenance_id)
);

-- ìˆ˜ë¦¬ì´ë ¥ (REPAIR)
CREATE TABLE REPAIR (
    repair_id      INT AUTO_INCREMENT,
    car_id         INT NOT NULL,
    accident_id    INT NOT NULL,
    start_date     DATE NOT NULL,
    end_date       DATE NOT NULL,
    repair_type    VARCHAR(20) NOT NULL,
    repair_fee     DECIMAL(20,2) NOT NULL,
    repair_vendor  VARCHAR(50) NOT NULL,
    is_deleted     BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (repair_id)
);
```

### [2] ì œì•½ì¡°ê±´ ì„¤ì •
```sql
-- =============================================
-- File: 02_Create-Constraints.sql
-- Description: Define FK & CHECK constraints
-- =============================================

-- CUSTOMER
ALTER TABLE CUSTOMER
ADD CONSTRAINT chk_customer_type CHECK (customer_type IN ('IN','CO'));

-- DRIVER
ALTER TABLE DRIVER
ADD CONSTRAINT fk_driver_customer FOREIGN KEY (customer_id) REFERENCES CUSTOMER(customer_id),
ADD CONSTRAINT chk_license_type CHECK (license_type IN ('êµ­ë‚´','êµ­ì œ')),
ADD CONSTRAINT chk_license_class CHECK (license_class IN ('1ì¢…ëŒ€í˜•','1ì¢…ë³´í†µ','2ì¢…ë³´í†µ','2ì¢…ì˜¤í† '));

-- CAR
ALTER TABLE CAR
ADD CONSTRAINT fk_car_branch FOREIGN KEY (branch_id) REFERENCES BRANCH(branch_id),
ADD CONSTRAINT chk_fuel_type CHECK (fuel_type IN ('ê°€ì†”ë¦°','ë””ì ¤','ì „ê¸°','í•˜ì´ë¸Œë¦¬ë“œ','LPG')),
ADD CONSTRAINT chk_car_year CHECK (car_year BETWEEN 2020 AND YEAR(CURDATE())),
ADD CONSTRAINT chk_seat_count CHECK (seat_count > 0),
ADD CONSTRAINT chk_car_mileage CHECK (car_mileage >= 0),
ADD CONSTRAINT chk_fuel_remaining CHECK (fuel_remaining >= 0),
ADD CONSTRAINT chk_car_status CHECK (car_status IN ('ëŒ€ì—¬ê°€ëŠ¥','ì˜ˆì•½ì™„ë£Œ','ëŒ€ì—¬ì¤‘','ì •ë¹„ì¤‘','ìˆ˜ë¦¬ì¤‘'));

-- RENTAL
ALTER TABLE RENTAL
ADD CONSTRAINT fk_rental_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT fk_rental_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_insurance_type CHECK (insurance_type IN ('ì™„ì „ë³´í—˜','ë¶€ë¶„ë³´í—˜','ë¯¸ì ìš©')),
ADD CONSTRAINT chk_start_fuel CHECK (start_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_return_fuel CHECK (return_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_rental_status CHECK (rental_status IN ('ì˜ˆì•½ì™„ë£Œ','ëŒ€ì—¬ì¤‘','ë°˜ë‚©ì™„ë£Œ','ì·¨ì†Œ'));

-- PAYMENT
ALTER TABLE PAYMENT
ADD CONSTRAINT fk_payment_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_payment_compensation FOREIGN KEY (compensation_id) REFERENCES COMPENSATION(compensation_id),
ADD CONSTRAINT chk_payment_type CHECK (payment_type IN ('ëŒ€ì—¬','ë³´ìƒ','ì¶”ê°€')),
ADD CONSTRAINT chk_payment_method CHECK (payment_method IN ('ì‹ ìš©ì¹´ë“œ','ì²´í¬ì¹´ë“œ','ê³„ì¢Œì´ì²´','ê°„í¸ê²°ì œ')),
ADD CONSTRAINT chk_payment_status CHECK (payment_status IN ('ê²°ì œì™„ë£Œ','ê²°ì œì‹¤íŒ¨','ê²°ì œì·¨ì†Œ'));

-- DISCOUNT_POLICY
ALTER TABLE DISCOUNT_POLICY
ADD CONSTRAINT chk_discount_type CHECK (discount_type IN ('ê¸ˆì•¡','ë¹„ìœ¨')),
ADD CONSTRAINT chk_discount_rate CHECK (discount_rate BETWEEN 1 AND 100);

-- MILEAGE_POLICY
ALTER TABLE MILEAGE_POLICY
ADD CONSTRAINT chk_earning_type CHECK (earning_type IN ('ê¸ˆì•¡','ë¹„ìœ¨')),
ADD CONSTRAINT chk_earning_rate CHECK (earning_rate BETWEEN 1 AND 100);

-- MAINTENANCE
ALTER TABLE MAINTENANCE
ADD CONSTRAINT fk_maintenance_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_maintenance_type CHECK (maintenance_type IN ('ì •ê¸°','ìˆ˜ì‹œ'));

-- ACCIDENT
ALTER TABLE ACCIDENT
ADD CONSTRAINT fk_accident_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_accident_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_accident_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT chk_accident_type CHECK (accident_type IN ('ì¶©ëŒ','ë‹¨ë…','ë³´í–‰ì','ìì—°','ê¸°íƒ€'));

-- REPAIR
ALTER TABLE REPAIR
ADD CONSTRAINT fk_repair_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_repair_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id),
ADD CONSTRAINT chk_repair_type CHECK (repair_type IN ('ì™¸ì¥ìˆ˜ë¦¬','ë‚´ì¥ìˆ˜ë¦¬','ì†Œëª¨í’ˆ','ê¸°íƒ€'));

-- COMPENSATION
ALTER TABLE COMPENSATION
ADD CONSTRAINT fk_compensation_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id);
```

### [3] ì¸ë±ìŠ¤ ì •ì˜
```sql
-- =============================================
-- File: 03_Create-Indexes.sql
-- Description: Create indexes for RentCar DB
-- =============================================

CREATE INDEX idx_customer_name ON CUSTOMER(customer_name);
CREATE INDEX idx_driver_license_number ON DRIVER(license_number);
CREATE INDEX idx_car_status ON CAR(car_status);
CREATE INDEX idx_rental_status ON RENTAL(rental_status);
CREATE INDEX idx_payment_datetime ON PAYMENT(payment_datetime);
CREATE INDEX idx_accident_datetime ON ACCIDENT(accident_datetime);
CREATE INDEX idx_repair_date ON REPAIR(start_date, end_date);
```
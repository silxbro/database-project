# 02. 데이터베이스 구축
<br/>

## 🖥️ 데이터베이스 환경 설정
### [1] Docker 기반 MySQL 로컬 서버

#### ◼︎ SSH를 활용한 EC2 서버 외부 접속
```
# 프라이빗 키 파일(.pem) 존재 경로로 이동 후, 프라이빗 키 조회(READ) 권한 부여
$ chmod 400 bh-EC2.pem

# ssh를 통한 서버 접속
ssh -i "[key-pair명].pem" ubuntu@[퍼블릭 DNS]
```

#### ◼︎ EC2 서버에 Docker 설치
```
# 시스템 업데이트
sudo apt update

# Docker 필수 패키지 설치
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# Docker GPG 키 추가
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Docker 저장소 추가
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Docker 설치
sudo apt update
sudo apt install -y docker-ce

# Docker 설치 확인
docker --version

# Docker 실행
sudo systemctl start docker
```

#### ◼︎ MySQL 이미지 다운로드
```
# ubuntu 사용자를 Docker 그룹에 추가: /var/run/docker.sock 파일(= Docker 데몬 소켓) 접근 권한 부여
sudo usermod -aG docker $USER

# EC2 서버 종료 후 재접속
exit
ssh -i "[key-pair명].pem" ubuntu@[퍼블릭 DNS]

# MySQL Docker 이미지 다운
docker pull mysql:latest

# MySQL 컨테이너 실행
docker run --name [컨테이너 이름] -e MYSQL_ROOT_PASSWORD=[비밀번호] -p 3306:3306 -d mysql:latest

# 컨테이너 상태 확인
docker ps
```

#### ◼︎ MYSQL 데이터 영속성 설정 (볼륨 마운트 설정)
```
# 볼륨 생성
docker volume create mysql-data

# 컨테이너 불륨 마운트
docker stop mysql-container
docker rm mysql-container
docker run --name mysql-container \
  -e MYSQL_ROOT_PASSWORD=ehpark \
  -v ~/mysql-data:/var/lib/mysql \
  -v ~/mysql-config/my.cnf \
  -p 3306:3306 \
  -d mysql:latest
```

#### ◼︎ MYSQL 서버 접속
```
# MySQL 서버 접속
docker exec -it mysql-container mysql -u root -p
```
<br/>

## 📑 DDL 스크립트

### [1] 테이블 생성
```sql
-- =============================================
-- File: 01_Create-Tables.sql
-- Description: Create tables for RentCar DB
-- =============================================

-- 회원 (MEMBER)
DROP TABLE IF EXIST MEMBER$$
CREATE TABLE MEMBER (
    member_id      INT AUTO_INCREMENT,
    account_id     VARCHAR(50) NOT NULL UNIQUE,
    account_pw     VARCHAR(50) NOT NULL,
    member_name    VARCHAR(50) NOT NULL,
    birth_date     DATE NOT NULL,
    gender         VARCHAR(10) NOT NULL,
    phone          VARCHAR(20) NOT NULL UNIQUE,
    email          VARCHAR(100) NOT NULL UNIQUE,
    join_date      DATE NOT NULL,
    withdraw_date  DATE NULL,
    status         VARCHAR(20) NOT NULL,
    PRIMARY KEY (customer_id)
);

-- 면허 (LICENSE)
DROP TABLE IF EXIST LICENSE$$
CREATE TABLE LICENSE (
    license_id      INT AUTO_INCREMENT,
    member_id       INT NOT NULL,
    license_number  VARCHAR(20) NOT NULL UNIQUE,
    license_type    VARCHAR(10) NOT NULL,
    license_class   VARCHAR(20) NOT NULL,
    issue_date      DATE NOT NULL,
    expiry_date     DATE NOT NULL,
    PRIMARY KEY (license_id)
);

-- 지점 (BRANCH)
DROP TABLE IF EXIST BRANCH$$
CREATE TABLE BRANCH (
    branch_id    INT AUTO_INCREMENT,
    branch_name  VARCHAR(50) NOT NULL UNIQUE,
    address      VARCHAR(100) NOT NULL,
    phone        VARCHAR(20) NOT NULL,
    open_time    TIME NOT NULL,
    close_time   TIME NOT NULL,
    open_date    DATE NOT NULL,
    close_date   DATE NULL,
    status       VARCHAR(20) NOT NULL,
    PRIMARY KEY (branch_id)
);

-- 지점직원 (BRANCH_STAFF)
DROP TABLE IF EXIST BRANCH_STAFF$$
CREATE TABLE BRANCH_STAFF (
    staff_id      INT AUTO_INCREMENT,
    branch_id     INT NOT NULL,
    staff_number  VARCHAR(50) NOT NULL UNIQUE,
    job_title     VARCHAR(20) NOT NULL,
    staff_name    VARCHAR(20) NOT NULL,
    birth_date    DATE NOT NULL,
    gender        VARCHAR(10) NOT NULL,
    phone         VARCHAR(20) NOT NULL UNIQUE,
    email         VARCHAR(100) NOT NULL UNIQUE,
    hire_date     DATE NOT NULL,
    retire_date   DATE NULL,
    status        VARCHAR(20) NOT NULL,
    PRIMARY KEY (staff_id)
);

-- 차량모델 (CAR_MODEL)
DROP TABLE IF EXIST CAR_MODEL$$
CREATE TABLE CAR_MODEL (
    car_model_id    INT AUTO_INCREMENT,
    car_model_type  VARCHAR(20) NOT NULL,
    car_model_base  VARCHAR(50) NOT NULL,
    maker_name      VARCHAR(50) NOT NULL,
    fuel_type       VARCHAR(20) NOT NULL,
    seat_count      INT NOT NULL,
    reg_date        DATE NOT NULL,
    del_date        DATE NULL,
    status          VARCHAR(20) NOT NULL,
    PRIMARY KEY (car_model_id)
);

-- 차량 (CAR)
DROP TABLE IF EXIST CAR$$
CREATE TABLE CAR (
    car_id          INT AUTO_INCREMENT,
    branch_id       INT NOT NULL,
    car_model_id    INT NOT NULL,
    car_number      VARCHAR(20) NOT NULL UNIQUE,
    car_year        INT NOT NULL,
    car_mileage     INT NOT NULL,
    fuel_remaining  INT NOT NULL,
    reg_date        DATE NOT NULL,
    del_date        DATE NULL,
    status          VARCHAR(20) NOT NULL,
    PRIMARY KEY (car_id)
);

-- 대여 (RENTAL)
DROP TABLE IF EXIST RENTAL$$
CREATE TABLE RENTAL (
    rental_id       INT AUTO_INCREMENT,
    car_id          INT NOT NULL,
    start_date      DATE NOT NULL,
    end_date        DATE NOT NULL,
    return_date     DATE NULL,
    insurance_type  VARCHAR(20) NOT NULL,
    start_fuel      INT NOT NULL,
    return_fuel     INT NULL,
    reserve_date    DATE NOT NULL,
    cancel_date     DATE NULL,
    status          VARCHAR(20) NOT NULL,
    PRIMARY KEY (rental_id)
);

-- 결제내역 (PAYMENT)
DROP TABLE IF EXIST PAYMENT$$
CREATE TABLE PAYMENT (
    payment_id         INT AUTO_INCREMENT,
    rental_id          INT NOT NULL,
    payment_amount     DECIMAL(20) NOT NULL,
    payment_datetime   DATETIME NOT NULL DEFAULT NOW(),
    payment_type       VARCHAR(20) NOT NULL,
    payment_method     VARCHAR(50) NOT NULL,
    payment_method_id  VARCHAR(50) NOT NULL,
    payment_status     VARCHAR(20) NOT NULL,
    PRIMARY KEY (payment_id)
);

-- 결제상세내역 (PAYMENT_DETAIL)
DROP TABLE IF EXIST PAYMENT_DETAIL$$
CREATE TABLE PAYMENT_DETAIL (
    payment_detail_id      INT AUTO_INCREMENT,
    payment_id             INT NOT NULL,
    policy_id              INT NULL,
    payment_detail_type    VARCHAR(20) NOT NULL,
    payment_detail_amount  DECIMAL(20) NOT NULL,
    PRIMARY KEY (payment_detail_id)
);

-- 대여료정책 (RENTAL_FEE_POLICY)
DROP TABLE IF EXIST RENTAL_FEE_POLICY$$
CREATE TABLE RENTAL_FEE_POLICY (
    fee_policy_id  INT AUTO_INCREMENT,
    car_model_id   INT NOT NULL,
    fee_amount     DECIMAL(20) NOT NULL,
    start_date     DATE NOT NULL,
    end_date       DATE NOT NULL,
    PRIMARY KEY (fee_policy_id)
);

-- 보험료정책 (INSURANCE_FEE_POLICY)
DROP TABLE IF EXIST INSURANCE_FEE_POLICY$$
CREATE TABLE INSURANCE_FEE_POLICY (
    fee_policy_id   INT AUTO_INCREMENT,
    insurance_type  VARCHAR(20) NOT NULL,
    fee_amount      DECIMAL(20) NOT NULL,
    start_date      DATE NOT NULL,
    end_date        DATE NOT NULL,
    PRIMARY KEY (fee_policy_id)
);

-- 할인정책 (DISCOUNT_POLICY)
DROP TABLE IF EXIST DISCOUNT_POLICY$$
CREATE TABLE DISCOUNT_POLICY (
    discount_policy_id  INT AUTO_INCREMENT,
    discount_type       VARCHAR(20) NOT NULL,
    discount_amount     DECIMAL(20) NULL,
    discount_rate       INT NULL,
    start_date          DATE NOT NULL,
    end_date            DATE NOT NULL,
    PRIMARY KEY (discount_policy_id)
);

-- 마일리지정책 (MILEAGE_POLICY)
DROP TABLE IF EXIST MILEAGE_POLICY$$
CREATE TABLE MILEAGE_POLICY (
    mileage_policy_id  INT AUTO_INCREMENT,
    earning_type       VARCHAR(20) NOT NULL,
    earning_amount     DECIMAL(20) NULL,
    earning_rate       INT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NOT NULL,
    PRIMARY KEY (mileage_policy_id)
);

-- 사고이력 (ACCIDENT)
DROP TABLE IF EXIST ACCIDENT$$
CREATE TABLE ACCIDENT (
    accident_id        INT AUTO_INCREMENT,
    rental_id          INT NOT NULL,
    accident_datetime  DATETIME NOT NULL,
    accident_type      VARCHAR(20) NOT NULL,
    accident_location  VARCHAR(100) NOT NULL,
    PRIMARY KEY (accident_id)
);

-- 차량관리이력 (CAR_MANAGEMENT)
DROP TABLE IF EXIST CAR_MANAGEMENT$$
CREATE TABLE CAR_MANAGEMENT (
    car_management_id  INT AUTO_INCREMENT,
    car_id             INT NOT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NULL,
    management_type    VARCHAR(20) NOT NULL,
    management_detail  VARCHAR(20) NOT NULL,
    management_cost    DECIMAL(20) NOT NULL,
    management_vendor  VARCHAR(50) NOT NULL,
    status  VARCHAR(20) NOT NULL,
    PRIMARY KEY (car_management_id)
);
```

### [2] 제약조건 설정
```sql
-- =============================================
-- File: 02_Create-Constraints.sql
-- Description: Define FK & CHECK constraints
-- =============================================

-- CUSTOMER
ALTER TABLE CUSTOMER
ADD CONSTRAINT chk_customer_type CHECK (customer_type IN ('IN','CO'));

-- DRIVER
ALTER TABLE DRIVER
ADD CONSTRAINT fk_driver_customer FOREIGN KEY (customer_id) REFERENCES CUSTOMER(customer_id),
ADD CONSTRAINT chk_license_type CHECK (license_type IN ('국내','국제')),
ADD CONSTRAINT chk_license_class CHECK (license_class IN ('1종대형','1종보통','2종보통','2종오토'));

-- CAR
ALTER TABLE CAR
ADD CONSTRAINT fk_car_branch FOREIGN KEY (branch_id) REFERENCES BRANCH(branch_id),
ADD CONSTRAINT chk_fuel_type CHECK (fuel_type IN ('가솔린','디젤','전기','하이브리드','LPG')),
ADD CONSTRAINT chk_car_year CHECK (car_year BETWEEN 2020 AND YEAR(CURDATE())),
ADD CONSTRAINT chk_seat_count CHECK (seat_count > 0),
ADD CONSTRAINT chk_car_mileage CHECK (car_mileage >= 0),
ADD CONSTRAINT chk_fuel_remaining CHECK (fuel_remaining >= 0),
ADD CONSTRAINT chk_car_status CHECK (car_status IN ('대여가능','예약완료','대여중','정비중','수리중'));

-- RENTAL
ALTER TABLE RENTAL
ADD CONSTRAINT fk_rental_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT fk_rental_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_insurance_type CHECK (insurance_type IN ('완전보험','부분보험','미적용')),
ADD CONSTRAINT chk_start_fuel CHECK (start_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_return_fuel CHECK (return_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_rental_status CHECK (rental_status IN ('예약완료','대여중','반납완료','취소'));

-- PAYMENT
ALTER TABLE PAYMENT
ADD CONSTRAINT fk_payment_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_payment_compensation FOREIGN KEY (compensation_id) REFERENCES COMPENSATION(compensation_id),
ADD CONSTRAINT chk_payment_type CHECK (payment_type IN ('대여','보상','추가')),
ADD CONSTRAINT chk_payment_method CHECK (payment_method IN ('신용카드','체크카드','계좌이체','간편결제')),
ADD CONSTRAINT chk_payment_status CHECK (payment_status IN ('결제완료','결제실패','결제취소'));

-- DISCOUNT_POLICY
ALTER TABLE DISCOUNT_POLICY
ADD CONSTRAINT chk_discount_type CHECK (discount_type IN ('금액','비율')),
ADD CONSTRAINT chk_discount_rate CHECK (discount_rate BETWEEN 1 AND 100);

-- MILEAGE_POLICY
ALTER TABLE MILEAGE_POLICY
ADD CONSTRAINT chk_earning_type CHECK (earning_type IN ('금액','비율')),
ADD CONSTRAINT chk_earning_rate CHECK (earning_rate BETWEEN 1 AND 100);

-- MAINTENANCE
ALTER TABLE MAINTENANCE
ADD CONSTRAINT fk_maintenance_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_maintenance_type CHECK (maintenance_type IN ('정기','수시'));

-- ACCIDENT
ALTER TABLE ACCIDENT
ADD CONSTRAINT fk_accident_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_accident_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_accident_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT chk_accident_type CHECK (accident_type IN ('충돌','단독','보행자','자연','기타'));

-- REPAIR
ALTER TABLE REPAIR
ADD CONSTRAINT fk_repair_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_repair_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id),
ADD CONSTRAINT chk_repair_type CHECK (repair_type IN ('외장수리','내장수리','소모품','기타'));

-- COMPENSATION
ALTER TABLE COMPENSATION
ADD CONSTRAINT fk_compensation_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id);
```

### [3] 인덱스 정의
```sql
-- =============================================
-- File: 03_Create-Indexes.sql
-- Description: Create indexes for RentCar DB
-- =============================================

CREATE INDEX idx_customer_name ON CUSTOMER(customer_name);
CREATE INDEX idx_driver_license_number ON DRIVER(license_number);
CREATE INDEX idx_car_status ON CAR(car_status);
CREATE INDEX idx_rental_status ON RENTAL(rental_status);
CREATE INDEX idx_payment_datetime ON PAYMENT(payment_datetime);
CREATE INDEX idx_accident_datetime ON ACCIDENT(accident_datetime);
CREATE INDEX idx_repair_date ON REPAIR(start_date, end_date);
```
# 02. 데이터베이스 구축
<br/>

## 📑 DDL 스크립트

### [1] 테이블 생성
```sql
-- =============================================
-- File: 01_Create-Tables.sql
-- Description: Create tables for RentCar DB
-- =============================================

-- 고객 (CUSTOMER)
CREATE TABLE CUSTOMER (
    customer_id       INT AUTO_INCREMENT,
    account_id        VARCHAR(50) NOT NULL UNIQUE,
    account_password  VARCHAR(50) NOT NULL,
    customer_name     VARCHAR(50) NOT NULL,
    customer_type     VARCHAR(10) NOT NULL,
    is_deleted        BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (customer_id)
);

-- 운전자 (DRIVER)
CREATE TABLE DRIVER (
    driver_id       INT AUTO_INCREMENT,
    customer_id     INT NOT NULL,
    driver_name     VARCHAR(50) NOT NULL,
    birth_date      DATE NOT NULL,
    license_type    VARCHAR(10) NOT NULL,
    license_class   VARCHAR(10) NOT NULL,
    license_number  VARCHAR(20) NOT NULL UNIQUE,
    issue_date      DATE NOT NULL,
    expiry_date     DATE NOT NULL,
    phone           VARCHAR(20) NOT NULL UNIQUE,
    email           VARCHAR(100) NOT NULL UNIQUE,
    is_deleted      BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (driver_id)
);

-- 지점 (BRANCH)
CREATE TABLE BRANCH (
    branch_id       INT AUTO_INCREMENT,
    branch_name     VARCHAR(50) NOT NULL UNIQUE,
    address         VARCHAR(100) NOT NULL,
    phone           VARCHAR(20) NOT NULL UNIQUE,
    open_time       TIME NOT NULL,
    close_time      TIME NOT NULL,
    is_deleted      BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (branch_id)
);

-- 차량 (CAR)
CREATE TABLE CAR (
    car_id          INT AUTO_INCREMENT,
    branch_id       INT NOT NULL,
    car_number      VARCHAR(20) NOT NULL UNIQUE,
    car_model       VARCHAR(50) NOT NULL,
    fuel_type       VARCHAR(10) NOT NULL,
    car_year        INT NOT NULL,
    seat_count      INT NOT NULL,
    car_mileage     INT NOT NULL,
    fuel_remaining  INT NOT NULL,
    car_status      VARCHAR(10) NOT NULL DEFAULT '대여가능',
    is_deleted      BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (car_id)
);

-- 대여 (RENTAL)
CREATE TABLE RENTAL (
    rental_id       INT AUTO_INCREMENT,
    driver_id       INT NOT NULL,
    car_id          INT NOT NULL,
    start_datetime  DATETIME NOT NULL,
    end_datetime    DATETIME NOT NULL,
    return_datetime DATETIME NULL,
    insurance_type  VARCHAR(20) NOT NULL,
    start_fuel      INT NOT NULL,
    return_fuel     INT NULL,
    rental_status   VARCHAR(20) NOT NULL DEFAULT '예약완료',
    PRIMARY KEY (rental_id)
);

-- 결제 (PAYMENT)
CREATE TABLE PAYMENT (
    payment_id        INT AUTO_INCREMENT,
    rental_id         INT NULL,
    compensation_id   INT NULL,
    payment_datetime  DATETIME NOT NULL DEFAULT NOW(),
    total_amount      DECIMAL(20,2) NOT NULL,
    payment_type      VARCHAR(20) NOT NULL,
    payment_method    VARCHAR(50) NOT NULL,
    payment_method_id VARCHAR(50) NOT NULL,
    payment_status    VARCHAR(20) NOT NULL,
    rental_amount     DECIMAL(20,2) NULL,
    insurance_fee     DECIMAL(20,2) NULL,
    discount_amount   DECIMAL(20,2) NULL,
    mileage_used      DECIMAL(20,2) NULL,
    mileage_earned    DECIMAL(20,2) NULL,
    PRIMARY KEY (payment_id)
);

-- 할인정책 (DISCOUNT_POLICY)
CREATE TABLE DISCOUNT_POLICY (
    discount_policy_id INT AUTO_INCREMENT,
    discount_type      VARCHAR(20) NOT NULL,
    discount_amount    DECIMAL(20,2) NULL,
    discount_rate      INT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (discount_policy_id)
);

-- 마일리지정책 (MILEAGE_POLICY)
CREATE TABLE MILEAGE_POLICY (
    mileage_policy_id  INT AUTO_INCREMENT,
    earning_type       VARCHAR(20) NOT NULL,
    earning_amount     DECIMAL(20,2) NULL,
    earning_rate       INT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (mileage_policy_id)
);

-- 정비이력 (MAINTENANCE)
CREATE TABLE MAINTENANCE (
    maintenance_id     INT AUTO_INCREMENT,
    car_id             INT NOT NULL,
    start_date         DATE NOT NULL,
    end_date           DATE NOT NULL,
    maintenance_type   VARCHAR(20) NOT NULL,
    maintenance_fee    DECIMAL(20,2) NOT NULL,
    maintenance_vendor VARCHAR(50) NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (maintenance_id)
);

-- 사고이력 (ACCIDENT)
CREATE TABLE ACCIDENT (
    accident_id        INT AUTO_INCREMENT,
    car_id             INT NOT NULL,
    rental_id          INT NULL,
    driver_id          INT NULL,
    accident_datetime  DATETIME NOT NULL,
    accident_type      VARCHAR(20) NOT NULL,
    accident_location  VARCHAR(50) NOT NULL,
    is_deleted         BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (accident_id)
);

-- 수리이력 (REPAIR)
CREATE TABLE REPAIR (
    repair_id      INT AUTO_INCREMENT,
    car_id         INT NOT NULL,
    accident_id    INT NULL,
    start_date     DATE NOT NULL,
    end_date       DATE NOT NULL,
    repair_type    VARCHAR(20) NOT NULL,
    repair_fee     DECIMAL(20,2) NOT NULL,
    repair_vendor  VARCHAR(50) NOT NULL,
    is_deleted     BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (repair_id)
);

-- 보상이력 (COMPENSATION)
CREATE TABLE COMPENSATION (
    compensation_id     INT AUTO_INCREMENT,
    accident_id         INT NOT NULL,
    compensation_amount DECIMAL(20,2) NOT NULL,
    compensation_date   DATE NOT NULL,
    is_deleted          BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (compensation_id)
);
```

### [2] 제약조건 설정
```sql
-- =============================================
-- File: 02_Create-Constraints.sql
-- Description: Define FK & CHECK constraints
-- =============================================

-- CUSTOMER
ALTER TABLE CUSTOMER
ADD CONSTRAINT chk_customer_type CHECK (customer_type IN ('개인','법인'));

-- DRIVER
ALTER TABLE DRIVER
ADD CONSTRAINT fk_driver_customer FOREIGN KEY (customer_id) REFERENCES CUSTOMER(customer_id),
ADD CONSTRAINT chk_license_type CHECK (license_type IN ('국내','국제')),
ADD CONSTRAINT chk_license_class CHECK (license_class IN ('1종대형','1종보통','2종보통','2종오토'));

-- CAR
ALTER TABLE CAR
ADD CONSTRAINT fk_car_branch FOREIGN KEY (branch_id) REFERENCES BRANCH(branch_id),
ADD CONSTRAINT chk_fuel_type CHECK (fuel_type IN ('가솔린','디젤','전기','하이브리드','LPG')),
ADD CONSTRAINT chk_car_year CHECK (car_year BETWEEN 2020 AND YEAR(CURDATE())),
ADD CONSTRAINT chk_seat_count CHECK (seat_count > 0),
ADD CONSTRAINT chk_car_mileage CHECK (car_mileage >= 0),
ADD CONSTRAINT chk_fuel_remaining CHECK (fuel_remaining >= 0),
ADD CONSTRAINT chk_car_status CHECK (car_status IN ('대여가능','예약완료','대여중','정비중','수리중'));

-- RENTAL
ALTER TABLE RENTAL
ADD CONSTRAINT fk_rental_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT fk_rental_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_insurance_type CHECK (insurance_type IN ('완전보험','부분보험','미적용')),
ADD CONSTRAINT chk_start_fuel CHECK (start_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_return_fuel CHECK (return_fuel BETWEEN 1 AND 10),
ADD CONSTRAINT chk_rental_status CHECK (rental_status IN ('예약완료','대여중','반납완료','취소'));

-- PAYMENT
ALTER TABLE PAYMENT
ADD CONSTRAINT fk_payment_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_payment_compensation FOREIGN KEY (compensation_id) REFERENCES COMPENSATION(compensation_id),
ADD CONSTRAINT chk_payment_type CHECK (payment_type IN ('대여','보상','추가')),
ADD CONSTRAINT chk_payment_method CHECK (payment_method IN ('신용카드','체크카드','계좌이체','간편결제')),
ADD CONSTRAINT chk_payment_status CHECK (payment_status IN ('결제완료','결제실패','결제취소'));

-- DISCOUNT_POLICY
ALTER TABLE DISCOUNT_POLICY
ADD CONSTRAINT chk_discount_type CHECK (discount_type IN ('금액','비율')),
ADD CONSTRAINT chk_discount_rate CHECK (discount_rate BETWEEN 1 AND 100);

-- MILEAGE_POLICY
ALTER TABLE MILEAGE_POLICY
ADD CONSTRAINT chk_earning_type CHECK (earning_type IN ('금액','비율')),
ADD CONSTRAINT chk_earning_rate CHECK (earning_rate BETWEEN 1 AND 100);

-- MAINTENANCE
ALTER TABLE MAINTENANCE
ADD CONSTRAINT fk_maintenance_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT chk_maintenance_type CHECK (maintenance_type IN ('정기','수시'));

-- ACCIDENT
ALTER TABLE ACCIDENT
ADD CONSTRAINT fk_accident_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_accident_rental FOREIGN KEY (rental_id) REFERENCES RENTAL(rental_id),
ADD CONSTRAINT fk_accident_driver FOREIGN KEY (driver_id) REFERENCES DRIVER(driver_id),
ADD CONSTRAINT chk_accident_type CHECK (accident_type IN ('충돌','단독','보행자','자연','기타'));

-- REPAIR
ALTER TABLE REPAIR
ADD CONSTRAINT fk_repair_car FOREIGN KEY (car_id) REFERENCES CAR(car_id),
ADD CONSTRAINT fk_repair_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id),
ADD CONSTRAINT chk_repair_type CHECK (repair_type IN ('외장수리','내장수리','소모품','기타'));

-- COMPENSATION
ALTER TABLE COMPENSATION
ADD CONSTRAINT fk_compensation_accident FOREIGN KEY (accident_id) REFERENCES ACCIDENT(accident_id);
```

### [3] 인덱스 정의
```sql
-- =============================================
-- File: 03_Create-Indexes.sql
-- Description: Create indexes for RentCar DB
-- =============================================

CREATE INDEX idx_customer_name ON CUSTOMER(customer_name);
CREATE INDEX idx_driver_license_number ON DRIVER(license_number);
CREATE INDEX idx_car_status ON CAR(car_status);
CREATE INDEX idx_rental_status ON RENTAL(rental_status);
CREATE INDEX idx_payment_datetime ON PAYMENT(payment_datetime);
CREATE INDEX idx_accident_datetime ON ACCIDENT(accident_datetime);
CREATE INDEX idx_repair_date ON REPAIR(start_date, end_date);
```